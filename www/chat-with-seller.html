<!DOCTYPE html>
<html>
<head>
  	<title>Chatting</title>
  	<meta name="viewport" content="width=device-width, initial-scale=1"> 
    <link rel="stylesheet" href="css/style-chat.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style type="text/css">   
    .body-after {
        content: "";
        position: fixed;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        display: none;
    }
    #refresh {
        position: fixed;
        top: 5px;
        right: 20px;
        background-color: #ffffff;
        width: 32px;
        height: 32px;
        border-radius: 40px;
        box-shadow: 0px 2px 7px rgba(0,0,0,0.1);
        padding: 8px 0 0 8px;
        z-index: 998;
    }
    .body-after:before {
        content: "Internet Connection Lost";
        position: absolute;
        top: 0;
        left: -15px;
        width: 100%;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-size: 18px;
        background: rgba(0, 0, 0, .8);
        padding: 15px;
    }
    .icon {
        fill: #000000;
        transform: rotate(0deg);
        transition: fill .25s ease, transform .25s ease;
    }

    .icon:hover {
        fill: #1059FF;
        transform: rotate(180deg);
    }
    </style>
</head>
<body>
    <div class="chat-container">
    	<div class="header-wrap">
    		<div class="icon-wrap">
    		   <a href="javascript: history.go(-1)"><i class="fa fa-angle-left"></i></a>
    	    </div>

    	    <div class="name-wrap">
    		   <h1 id="userName">Dipika Mehra</h1>
		       <div class="status">
				   <i class="fa fa-envelope"></i> 
				</div>
    	    </div>
    	</div>

    	<div class="inner-block">
    	    <div class="slider-wrap">
  	    		<div class="slider-title">
  	    		   <span><a href="home.html">View Premium Featured Ads</a></span>
  	    		</div>
    	    </div>
    	    <div class="chatting-wrap">
	    		<div class="time-wrap">
	    			<span>Recent Chat</span>
	    		</div>
              
    	    </div>

            <div class="chat-end-section">
		    	<form class="msger-inputarea">
					<input type="text" class="msger-input" placeholder="Type your message..." required>
          <input type="hidden" name="lastChatId" id="lastChatId" value="0">
					<button type="submit" class="msger-send-btn"><i class="fa fa-paper-plane"></i></button>
				</form>
		   </div>
	    </div>
    </div>
    <a href="#" id="refresh" value="Refresh" onClick="history.go()" style="display: none;">
      <svg class="icon"   version="1.1" id="Capa_1"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
       width="25px" height="25px" viewBox="0 0 322.447 322.447" style="enable-background:new 0 0 322.447 322.447;"
       xml:space="preserve">
          <g>
            <path  d="M321.832,230.327c-2.133-6.565-9.184-10.154-15.75-8.025l-16.254,5.281C299.785,206.991,305,184.347,305,161.224
              c0-84.089-68.41-152.5-152.5-152.5C68.411,8.724,0,77.135,0,161.224s68.411,152.5,152.5,152.5c6.903,0,12.5-5.597,12.5-12.5
              c0-6.902-5.597-12.5-12.5-12.5c-70.304,0-127.5-57.195-127.5-127.5c0-70.304,57.196-127.5,127.5-127.5
              c70.305,0,127.5,57.196,127.5,127.5c0,19.372-4.371,38.337-12.723,55.568l-5.553-17.096c-2.133-6.564-9.186-10.156-15.75-8.025
              c-6.566,2.134-10.16,9.186-8.027,15.751l14.74,45.368c1.715,5.283,6.615,8.642,11.885,8.642c1.279,0,2.582-0.198,3.865-0.614
              l45.369-14.738C320.371,243.946,323.965,236.895,321.832,230.327z"/>
          </g>
      </svg>
   </a>
 <script src="js/jquery.min.js"></script>
  <script src="https://code.jquery.com/jquery-migrate-1.4.1.min.js"></script>
  <script src="js/network.js"></script>       
    <script type="text/javascript">
      $( document ).ready(function(){
        function getSearchParams(k){
          var p={};
          location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(s,k,v){p[k]=v})
          return k?p[k]:p;
        }    
        var sellerId = getSearchParams('sellerId');
        var adId = getSearchParams('adId');
        var userData =localStorage.getItem("user_data");
        userData = $.parseJSON(userData);
        if(userData != null){
          var idUser = userData.userId;
        }
        var currentUserId = idUser;  
        var globalurl = "https://www.yessellit.nl/api";             
        // product api    
        var url = globalurl+"/addchats-app.php";
        // Button click
        $('button.msger-send-btn').live('click', function(e) {
          e.preventDefault();
          var userMessage = $('.msger-input').val();
          if(userMessage != ''){
              var messageAdd = `<div class="msg right-msg"><div class="msg-bubble"><div class="msg-text">`+userMessage+`</div></div></div>`;
              $('.msger-input').val('');

              $.ajax({
                type: "GET",
                url: url,
                data: {
                      to_user      : sellerId,
                      from_user    : currentUserId,
                      message      : userMessage,
                      adid         : adId              
                    },
                cache: false,
                success: function(data){
                  $('.loader').hide(500);
                  var products = $.parseJSON(data);
                  var status_code =products.meta.code;
                  if(status_code == 200){
                     console.log(products.meta.message);
                  }
                },
                error: function(error){
                  console.log(error.status);
                 },         
              });
          }          
        });        
    });
  </script>
  <script type="text/javascript">
      $( document ).ready(function(){
        function getSearchParams(k){
          var p={};
          location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(s,k,v){p[k]=v})
          return k?p[k]:p;
        }    
        var sellerId = getSearchParams('sellerId');
        var adId = getSearchParams('adId');
        var username = getSearchParams('username');
        var useremail = getSearchParams('useremail');
        $('#userName').text(decodeURI(username));
        var mailto = '<a href="mailto:'+useremail+'">'+useremail+'</a>';
        $('.status').append(mailto);
        var userData =localStorage.getItem("user_data");
        userData = $.parseJSON(userData);
        if(userData != null){
          var idUser = userData.userId;
        }
        var currentUserId = idUser;  
        var globalurl = "https://www.yessellit.nl/api";             
        // product api    
        var url = globalurl+"/displayuserchats-app.php";
        var lastChatId = '';
              $.ajax({
                type: "GET",
                url: url,
                data: {
                      to_user      : sellerId,
                      from_user    : currentUserId,
                    },
                cache: false,
                success: function(data){
                  $('.loader').hide(500);
                  var products = $.parseJSON(data);
                  var status_code =products.meta.code;
                  if(status_code == 200){
                     var product = products.data;
                     productLength = product.length;
                     if(productLength != 0){              
                       for (var i = 0; i < productLength; i++)
                        {
                          var to_user_id = product[i].to_user_id;
                          var from_user_id = product[i].from_user_id;
                          if( to_user_id == sellerId && to_user_id != currentUserId  ){
                            var to_user_message = product[i].message;
                            var messageAdd = `<div class="msg right-msg"><div class="msg-bubble"><div class="msg-text">`+to_user_message+`</div></div></div>`;
                            $('.chatting-wrap').append(messageAdd);
                          }else{
                            var to_user_message = product[i].message;
                            var messageAdd = `<div class="msg left-msg"><div class="msg-bubble"><div class="msg-text">`+to_user_message+`</div></div></div>`;
                            $('.chatting-wrap').append(messageAdd);
                          }                     
                        }
                      i = i-1;
                      var lastChatId = product[i].message_id;
                      $('#lastChatId').val(lastChatId);
                    }
                  }
                },
                error: function(error){
                  console.log(error.status);
                 },         
              });
              // Load More Messages .....................................................................
              setInterval(function(){
                    var lastChatMessageId = $('#lastChatId').val();
                    if(lastChatMessageId != '' && lastChatMessageId != 0){
                      $.ajax({
                      type: "GET",
                      url: url,
                      data: {
                            to_user      : sellerId,
                            from_user    : currentUserId,
                            last_message_id: lastChatMessageId,
                          },
                      cache: false,
                      success: function(data){
                        $('.loader').hide(500);
                        var products = $.parseJSON(data);
                        var status_code =products.meta.code;
                        if(status_code == 200){
                           var product = products.data;
                           productLength = product.length;
                           if(productLength != 0){
                            for (var i = 0; i < productLength; i++)
                            {
                              var to_user_id = product[i].to_user_id;
                              var from_user_id = product[i].from_user_id;
                              if( to_user_id == sellerId && to_user_id != currentUserId  ){
                                var to_user_message = product[i].message;
                                var messageAdd = `<div class="msg right-msg"><div class="msg-bubble"><div class="msg-text">`+to_user_message+`</div></div></div>`;
                                $('.chatting-wrap').append(messageAdd);
                              }else{
                                var to_user_message = product[i].message;
                                var messageAdd = `<div class="msg left-msg"><div class="msg-bubble"><div class="msg-text">`+to_user_message+`</div></div></div>`;
                                $('.chatting-wrap').append(messageAdd);
                              }                     
                            }
                            i = i-1;
                            var lastChatId = product[i].message_id;
                            $('#lastChatId').val(lastChatId);
                           }                         
                        }
                      },
                      error: function(error){
                        console.log(error.status);
                       },         
                    });
                    }else{
                      $.ajax({
                        type: "GET",
                        url: url,
                        data: {
                              to_user      : sellerId,
                              from_user    : currentUserId,
                            },
                        cache: false,
                        success: function(data){
                          $('.loader').hide(500);
                          var products = $.parseJSON(data);
                          var status_code =products.meta.code;
                          if(status_code == 200){
                             var product = products.data;
                             productLength = product.length;
                             if(productLength != 0){
                              for (var i = 0; i < productLength; i++)
                              {
                                var to_user_id = product[i].to_user_id;
                                var from_user_id = product[i].from_user_id;
                                if( to_user_id == sellerId && to_user_id != currentUserId  ){
                                  var to_user_message = product[i].message;
                                  var messageAdd = `<div class="msg right-msg"><div class="msg-bubble"><div class="msg-text">`+to_user_message+`</div></div></div>`;
                                  $('.chatting-wrap').append(messageAdd);
                                }else{
                                  var to_user_message = product[i].message;
                                  var messageAdd = `<div class="msg left-msg"><div class="msg-bubble"><div class="msg-text">`+to_user_message+`</div></div></div>`;
                                  $('.chatting-wrap').append(messageAdd);
                                }                     
                              }
                              i = i-1;
                            var lastChatId = product[i].message_id;
                            $('#lastChatId').val(lastChatId);
                            }                         
                          }
                        },
                        error: function(error){
                          console.log(error.status);
                        },         
                      });
                    }
                        
               }, 2000);     
              // Load More ends ................................................................
              
    });
  </script>
</body>
</html>